<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Treino Interativo v8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Teko:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .font-display { font-family: 'Teko', sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; color: #9ca3af; }
        .tab-button.active { color: #a78bfa; border-bottom-color: #a78bfa; }
        .tab-button.locked { opacity: 0.5; cursor: not-allowed; }
        .tab-button-highlight { background-color: #5b21b6; color: white; border-radius: 6px 6px 0 0; }
        .tab-button-highlight.active { background-color: #6d28d9; color: white; border-bottom-color: #a78bfa; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .exercise-checkbox { appearance: none; background-color: #374151; border: 2px solid #4b5563; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; position: relative; transition: all 0.2s ease; flex-shrink: 0; }
        .exercise-checkbox:checked { background-color: #8b5cf6; border-color: #a78bfa; }
        .exercise-checkbox:checked::after { content: '✔'; color: white; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 16px; }
        .exercise-label { cursor: pointer; flex-grow: 1; }
        .calendar-grid-class { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { display: flex; align-items: center; justify-content: center; height: 40px; background-color: #1f2937; border-radius: 50%; position: relative; }
        .calendar-day.other-month { color: #4b5563; }
        .calendar-day.has-workout { cursor: pointer; border: 1px solid #a78bfa; }
        .calendar-day.has-workout::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: #a78bfa; border-radius: 50%; }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .difficulty-btn { transition: transform 0.2s; }
        .difficulty-btn.selected { transform: scale(1.25); }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-6 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="font-display text-5xl md:text-6xl font-bold text-white tracking-wide">PAINEL DE TREINO</h1>
            <p class="text-lg text-gray-400 mt-1">Seu Guia de Treino Interativo de 6 Meses</p>
        </header>

        <nav class="mb-8 border-b border-gray-700">
             <ul class="flex flex-wrap -mb-px justify-center text-sm font-medium text-center items-end">
                <li class="mr-2"><button class="tab-button tab-button-highlight inline-block p-4 active" data-tab="dashboard">Dashboard</button></li>
                <li class="mr-2"><button class="tab-button inline-block p-4 rounded-t-lg" data-tab="fase-a">Fase A</button></li>
                <li class="mr-2"><button class="tab-button inline-block p-4 rounded-t-lg" data-tab="fase-b">Fase B</button></li>
                <li class="mr-2"><button class="tab-button inline-block p-4 rounded-t-lg" data-tab="fase-c">Fase C</button></li>
                <li class="mr-2"><button class="tab-button inline-block p-4 rounded-t-lg" data-tab="historico">Histórico</button></li>
            </ul>
        </nav>

        <main>
            </main>
    </div>

    <div id="completion-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-md w-full text-center border-2 border-violet-500">
            <h2 class="text-2xl font-bold text-white mb-2">Avalie seu Treino</h2>
            <p id="modal-score-placeholder" class="text-gray-400 mb-6">Selecione uma dificuldade para ver sua nota.</p>
            <p id="modal-score" class="font-display text-7xl text-violet-400 font-bold my-2 h-20"></p>
            <p class="text-gray-300 mb-2">Qual foi a dificuldade da sessão?</p>
            <div class="difficulty-ratings flex justify-center space-x-2 md:space-x-4 mb-6"></div>
            <button id="save-workout-btn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Confirmar e Salvar</button>
        </div>
    </div>

    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-2xl w-full border-2 border-blue-500 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start">
                <h2 id="edit-modal-title" class="text-2xl font-bold text-white mb-4">Editar Registro</h2>
                <div class="text-right">
                    <p class="text-gray-400 text-sm">Nota do Treino</p>
                    <p id="edit-modal-score" class="font-display text-4xl text-blue-400"></p>
                </div>
            </div>
            <div id="edit-modal-exercises" class="mb-6"></div>
            <hr class="border-gray-600 my-4">
            <h3 class="text-lg font-bold text-white mb-2">Dificuldade do Treino</h3>
            <div id="edit-modal-difficulty" class="difficulty-ratings flex justify-center space-x-2 md:space-x-4 mb-6"></div>
            <hr class="border-gray-600 my-4">
            <h3 class="text-lg font-bold text-white mb-2">Detalhes do Cardio</h3>
            <div id="edit-modal-cardio" class="space-y-4"></div>
             <hr class="border-gray-600 my-6">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                <button id="save-edit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar Alterações</button>
                <button id="delete-log-btn" class="w-full btn-danger font-bold py-2 px-4 rounded-lg transition-colors">Excluir Registro</button>
                <button class="close-modal-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>


    <script>
    // --- DATABASE ---
    const workoutDatabase = { "A":{days:[{idPrefix:'a-d1',title:"Dia 1: Peito e Ombro",exercises:[{id:"a-d1-ex1",text:"<strong>Peck Deck (Voador):</strong> 4 séries de 10-12 reps"},{id:"a-d1-ex2",text:"<strong>Supino Inclinado c/ Halteres:</strong> 4 séries de 8-10 reps"},{id:"a-d1-ex3",text:"<strong>Supino Reto c/ Barra:</strong> 3 séries de 10 reps"},{id:"a-d1-ex4",text:"<strong>Desenv. de Ombros na Máquina:</strong> 3 séries de 10-12 reps"},{id:"a-d1-ex5",text:"<strong>Elevação Lateral c/ Halteres (sentado):</strong> 3 séries de 12-15 reps"},{id:"a-d1-ex6",text:"<strong>Face Pull na Polia:</strong> 4 séries de 15 reps"}]},{idPrefix:'a-d2',title:"Dia 2: Costas",exercises:[{id:"a-d2-ex1",text:"<strong>Lat Pulldown (Puxada Frontal):</strong> 4 séries de 10-12 reps"},{id:"a-d2-ex2",text:"<strong>Remada Curvada c/ Barra:</strong> 4 séries de 8-10 reps"},{id:"a-d2-ex3",text:"<strong>Remada Baixa (c/ Triângulo):</strong> 3 séries de 10-12 reps"},{id:"a-d2-ex4",text:"<strong>Puxada Unilateral na Polia:</strong> 3 séries de 12 reps/lado"},{id:"a-d2-ex5",text:"<strong>Pulldown com Corda na Polia Alta:</strong> 3 séries de 12 reps"}]},{idPrefix:'a-d3',title:"Dia 3: Pernas",exercises:[{id:"a-d3-ex1",text:"<strong>Agachamento no Hack Machine:</strong> 4 séries de 10-12 reps"},{id:"a-d3-ex2",text:"<strong>Leg Press 45°:</strong> 3 séries de 10 reps"},{id:"a-d3-ex3",text:"<strong>Cadeira Extensora:</strong> 3 séries de 12 reps"},{id:"a-d3-ex4",text:"<strong>Mesa Flexora:</strong> 3 séries de 10-12 reps"},{id:"a-d3-ex5",text:"<strong>Stiff com Halteres:</strong> 4 séries de 12 reps"},{id:"a-d3-ex6",text:"<strong>Panturrilha no Leg Press:</strong> 4 séries de 15-20 reps"}]},{idPrefix:'a-d4',title:"Dia 4: Braços e Abdômen",exercises:[{id:"a-d4-ex1",text:"<strong>BÍCEPS - Rosca Direta c/ Barra W:</strong> 3 séries de 10 reps"},{id:"a-d4-ex2",text:"<strong>BÍCEPS - Rosca Martelo c/ Halteres:</strong> 3 séries de 10 reps/braço"},{id:"a-d4-ex3",text:"<strong>BÍCEPS - Rosca Concentrada no Banco:</strong> 3 séries de 12 reps"},{id:"a-d4-ex4",text:"<strong>TRÍCEPS - Tríceps na Polia com Corda:</strong> 4 séries de 12 reps"},{id:"a-d4-ex5",text:"<strong>TRÍCEPS - Tríceps Testa c/ Halteres:</strong> 3 séries de 12 reps"},{id:"a-d4-ex6",text:"<strong>TRÍCEPS - Mergulho entre Bancos:</strong> 3 séries até a falha"},{id:"a-d4-ex7",text:"<strong>ANTEBRAÇO - Rosca Inversa c/ Barra:</strong> 3 séries de 15 reps"},{id:"a-d4-ex8",text:"<strong>ABDÔMEN - Prancha Isométrica:</strong> 3 séries até a falha"},{id:"a-d4-ex9",text:"<strong>ABDÔMEN - Elevação de Pernas:</strong> 3 séries de 15 reps"}]},{idPrefix:'a-d5',title:"Dia 5: Full Body (Opcional)",exercises:[{id:"a-d5-ex1",text:"<strong>Leg Press Horizontal:</strong> 3 séries de 12 reps"},{id:"a-d5-ex2",text:"<strong>Supino Reto com Halteres:</strong> 3 séries de 10 reps"},{id:"a-d5-ex3",text:"<strong>Remada na Máquina:</strong> 3 séries de 12 reps"},{id:"a-d5-ex4",text:"<strong>Elevação Lateral c/ Halteres:</strong> 3 séries de 15 reps"},{id:"a-d5-ex5",text:"<strong>Rosca Polia + Tríceps Polia (Bi-set):</strong> 3 séries de 12+12 reps"}]}]}, "B":{days:[{idPrefix:'b-d1',title:"Dia 1: Peito e Ombro",exercises:[{id:"b-d1-ex1",text:"<strong>Supino Reto c/ Halteres:</strong> 4 séries de 8-10-10-12 reps"},{id:"b-d1-ex2",text:"<strong>Peck Deck:</strong> 3x 10-12 reps + Drop Set na última"},{id:"b-d1-ex3",text:"<strong>Crucifixo Inclinado c/ Halteres:</strong> 3 séries de 12 reps"},{id:"b-d1-ex4",text:"<strong>Desenvolvimento Arnold:</strong> 3 séries de 10 reps"},{id:"b-d1-ex5",text:"<strong>Elevação Lateral na Polia:</strong> 3 séries de 12-15 reps"},{id:"b-d1-ex6",text:"<strong>Face Pull na Polia:</strong> 4 séries de 15 reps"}]},{idPrefix:'b-d2',title:"Dia 2: Costas",exercises:[{id:"b-d2-ex1",text:"<strong>Levantamento Terra ou Stiff:</strong> 4 séries de 8 reps"},{id:"b-d2-ex2",text:"<strong>Remada Curvada no Smith:</strong> 4 séries de 10 reps"},{id:"b-d2-ex3",text:"<strong>Puxada Frontal com Triângulo:</strong> 3 séries de 10-12 reps"},{id:"b-d2-ex4",text:"<strong>Remada na Máquina (pronada):</strong> 3 séries de 12 reps"},{id:"b-d2-ex5",text:"<strong>Pulldown com Barra Reta:</strong> 3 séries de 15 reps"}]},{idPrefix:'b-d3',title:"Dia 3: Pernas",exercises:[{id:"b-d3-ex1",text:"<strong>Leg Press 45°:</strong> 4 séries de 10-12 reps"},{id:"b-d3-ex2",text:"<strong>Agachamento Hack:</strong> 3 séries de 10 reps"},{id:"b-d3-ex3",text:"<strong>Cadeira Flexora:</strong> 3 séries de 12 reps"},{id:"b-d3-ex4",text:"<strong>Cadeira Extensora:</strong> 3 séries de 15 reps"},{id:"b-d3-ex5",text:"<strong>Cadeira Abdutora:</strong> 3 séries de 15 reps"},{id:"b-d3-ex6",text:"<strong>Panturrilha em Pé na Máquina:</strong> 4 séries de 15 reps"}]},{idPrefix:'b-d4',title:"Dia 4: Braços e Abdômen",exercises:[{id:"b-d4-ex1",text:"<strong>Rosca Scott na Máquina:</strong> 3 séries de 10-12 reps"},{id:"b-d4-ex2",text:"<strong>Rosca Inclinada c/ Halteres:</strong> 3 séries de 12 reps"},{id:"b-d4-ex3",text:"<strong>Tríceps na Polia com Barra Reta:</strong> 4 séries de 12 reps"},{id:"b-d4-ex4",text:"<strong>Tríceps Francês com Barra W:</strong> 3 séries de 10-12 reps"},{id:"b-d4-ex5",text:"<strong>Abdominal na Máquina ou Corda:</strong> 3 séries de 15 reps"},{id:"b-d4-ex6",text:"<strong>Prancha Lateral:</strong> 3 séries de 30-45s por lado"}]},{idPrefix:'b-d5',title:"Dia 5: Full Body (Opcional)",exercises:[{id:"b-d5-ex1",text:"<strong>Agachamento Hack:</strong> 3 séries de 12 reps"},{id:"b-d5-ex2",text:"<strong>Supino Inclinado com Halteres:</strong> 3 séries de 10 reps"},{id:"b-d5-ex3",text:"<strong>Remada Curvada com Halteres:</strong> 3 séries de 12 reps"},{id:"b-d5-ex4",text:"<strong>Desenvolvimento na Máquina:</strong> 3 séries de 12 reps"},{id:"b-d5-ex5",text:"<strong>Rosca Martelo + Tríceps Coice (Bi-set):</strong> 3 séries de 10+10 reps"}]}]}, "C":{days:[{idPrefix:'c-d1',title:"Dia 1: Peito e Tríceps",exercises:[{id:"c-d1-ex1",text:"<strong>Supino Inclinado c/ Barra:</strong> 4 séries de 10 reps"},{id:"c-d1-ex2",text:"<strong>Supino Reto c/ Halteres:</strong> 3 séries de 10-12 reps"},{id:"c-d1-ex3",text:"<strong>Peck Deck (Voador):</strong> 3 séries de 12 reps"},{id:"c-d1-ex4",text:"<strong>Tríceps Testa na Polia (deitado):</strong> 4 séries de 12 reps"},{id:"c-d1-ex5",text:"<strong>Tríceps Corda na Polia Alta:</strong> 3 séries de 12-15 reps"},{id:"c-d1-ex6",text:"<strong>Extensão Unilateral Invertida:</strong> 3 séries de 15 reps/braço"}]},{idPrefix:'c-d2',title:"Dia 2: Costas e Bíceps",exercises:[{id:"c-d2-ex1",text:"<strong>Levantamento Terra Romeno:</strong> 4 séries de 12 reps"},{id:"c-d2-ex2",text:"<strong>Remada Cavalinho ou Baixa:</strong> 4 séries de 10 reps"},{id:"c-d2-ex3",text:"<strong>Puxada Alta no Pulley:</strong> 3 séries de 12 reps"},{id:"c-d2-ex4",text:"<strong>Rosca Direta com Barra W:</strong> 4 séries de 10-12 reps"},{id:"c-d2-ex5",text:"<strong>Rosca Alternada com Halteres:</strong> 3 séries de 10 reps/braço"},{id:"c-d2-ex6",text:"<strong>Rosca Martelo com Corda na Polia:</strong> 3 séries de 12-15 reps"}]},{idPrefix:'c-d3',title:"Dia 3: Pernas",exercises:[{id:"c-d3-ex1",text:"<strong>Agachamento no Hack:</strong> 4 séries de 8-10 reps"},{id:"c-d3-ex2",text:"<strong>Leg Press Horizontal:</strong> 4 séries de 15 reps"},{id:"c-d3-ex3",text:"<strong>Cadeira Extensora (unilateral):</strong> 3 séries de 12 reps/perna"},{id:"c-d3-ex4",text:"<strong>Mesa Flexora (unilateral):</strong> 3 séries de 12 reps/perna"},{id:"c-d3-ex5",text:"<strong>Cadeira Adutora:</strong> 4 séries de 15 reps"},{id:"c-d3-ex6",text:"<strong>Panturrilha Sentado:</strong> 4 séries de 15-20 reps"}]},{idPrefix:'c-d4',title:"Dia 4: Ombros e Abdômen",exercises:[{id:"c-d4-ex1",text:"<strong>Desenvolvimento c/ Halteres:</strong> 4 séries de 10 reps"},{id:"c-d4-ex2",text:"<strong>Elev. Lateral + Frontal (Bi-set):</strong> 3 séries de 10+10 reps"},{id:"c-d4-ex3",text:"<strong>Crucifixo Inverso na Máquina:</strong> 4 séries de 15 reps"},{id:"c-d4-ex4",text:"<strong>Abdominal Canivete:</strong> 3 séries até a falha"},{id:"c-d4-ex5",text:"<strong>Rotação de Tronco na Polia:</strong> 3 séries de 15 reps/lado"}]},{idPrefix:'c-d5',title:"Dia 5: Full Body (Opcional)",exercises:[{id:"c-d5-ex1",text:"<strong>Cadeira Extensora + Mesa Flexora (Bi-set):</strong> 3 de 12+12 reps"},{id:"c-d5-ex2",text:"<strong>Supino Reto no Smith:</strong> 3 séries de 12 reps"},{id:"c-d5-ex3",text:"<strong>Lat Pulldown (pegada neutra):</strong> 3 séries de 12 reps"},{id:"c-d5-ex4",text:"<strong>Elevação Lateral na Máquina:</strong> 3 séries de 15 reps"},{id:"c-d5-ex5",text:"<strong>Abdominal na Máquina:</strong> 3 séries de 20 reps"}]}]}};

    document.addEventListener('DOMContentLoaded', () => {
        let workoutLog = JSON.parse(localStorage.getItem('workoutLog')) || {};
        const getTodayKey = () => new Date().toISOString().split('T')[0];
        let currentCalendarDate = new Date();
        let activeModal = null;
        let editLogKey = null;

        const mainEl = document.querySelector('main');
        const difficultyEmojis = `<button data-value="1" title="Muito Fácil" class="difficulty-btn text-4xl">😊</button><button data-value="2" title="Fácil" class="difficulty-btn text-4xl">🙂</button><button data-value="3" title="Moderado" class="difficulty-btn text-4xl">😐</button><button data-value="4" title="Difícil" class="difficulty-btn text-4xl">😟</button><button data-value="5" title="Exaustivo" class="difficulty-btn text-4xl">🥵</button>`;
        const phaseAccessRules = { 'fase-a': [7, 8], 'fase-b': [9, 10], 'fase-c': [11, 12] };
        
        function saveState() { localStorage.setItem('workoutLog', JSON.stringify(workoutLog)); }
        function openModal(modalId) {
            closeAllModals();
            activeModal = document.getElementById(modalId);
            if (activeModal) activeModal.classList.add('active');
        }
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            activeModal = null;
        }
        function getWeekRange(date) {
            const start = new Date(date.getTime());
            const day = start.getDay() || 7;
            if (day !== 1) start.setHours(-24 * (day - 1));
            start.setHours(0, 0, 0, 0);
            const end = new Date(start.getTime());
            end.setDate(end.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            return { start, end };
        }

        function buildLayout() {
            let html = `
            <section id="dashboard" class="content-section active">
                 <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center"><p class="text-gray-400 text-sm">Dias Treinados (Mês)</p><p id="stat-days-trained" class="text-3xl lg:text-4xl font-bold text-white">-</p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center"><p class="text-gray-400 text-sm">Média de Nota (Mês)</p><p id="stat-avg-score-month" class="text-3xl lg:text-4xl font-bold text-white">-</p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center"><p class="text-gray-400 text-sm">Média de Nota (Semana)</p><p id="stat-avg-score-week" class="text-3xl lg:text-4xl font-bold text-white">-</p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center"><p class="text-gray-400 text-sm">Minutos de Cardio (Mês)</p><p id="stat-cardio-minutes" class="text-3xl lg:text-4xl font-bold text-white">-</p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center col-span-2 lg:col-span-2"><p class="text-gray-400 text-sm">Cardio Preferido</p><p id="stat-fav-cardio" class="text-2xl lg:text-3xl font-bold text-white">-</p></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center col-span-2 lg:col-span-2"><p class="text-gray-400 text-sm">Treino Mais Frequente</p><p id="stat-fav-workout" class="text-xl lg:text-3xl font-bold text-white">-</p></div>
                </div>
            </section>`;
            
            Object.keys(workoutDatabase).forEach(phaseKey => {
                const phaseData = workoutDatabase[phaseKey];
                html += `<section id="fase-${phaseKey.toLowerCase()}" class="content-section" data-phase="${phaseKey}"><div class="space-y-6">`;
                phaseData.days.forEach(day => {
                    html += `<div class="bg-gray-800 p-6 rounded-xl shadow-lg" data-day-title="${day.title}" data-id-prefix="${day.idPrefix}">
                        <h3 class="text-2xl font-bold mb-4 text-white">${day.title.replace(/\(Opcional\)/g, '<span class="text-base font-normal text-gray-400">(Opcional)</span>')}</h3>
                        <ul class="space-y-3 exercise-list">`;
                    day.exercises.forEach(ex => { html += `<li class="flex items-center"><input type="checkbox" id="${ex.id}" class="exercise-checkbox mr-4"><label for="${ex.id}" class="exercise-label">${ex.text}</label></li>`; });
                    html += `</ul>
                        <hr class="border-gray-600 my-6">
                        <div class="space-y-4 cardio-section">
                            <h4 class="font-bold text-lg text-white">Cardio (Opcional)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="cardio-type-${day.idPrefix}" class="block text-sm text-gray-400 mb-1">Tipo</label><select id="cardio-type-${day.idPrefix}" class="w-full p-2 rounded bg-gray-700 text-white"><option>Esteira</option><option>Bicicleta</option><option>Elíptico</option><option>Outro</option></select></div>
                                <div><label for="cardio-minutes-${day.idPrefix}" class="block text-sm text-gray-400 mb-1">Minutos</label><input type="number" id="cardio-minutes-${day.idPrefix}" class="w-full p-2 rounded bg-gray-700 text-white" placeholder="0"></div>
                            </div>
                            <div><p class="text-sm text-gray-400 mb-2">Dificuldade do Cardio</p><div class="difficulty-ratings flex justify-start space-x-4">${difficultyEmojis}</div></div>
                        </div>
                        <button class="finish-workout-btn mt-8 w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Finalizar Treino e Avaliar</button>
                    </div>`;
                });
                html += `</div></section>`;
            });

            html += `<section id="historico" class="content-section"><div class="bg-gray-800 p-6 rounded-xl shadow-lg"><div id="calendar-header" class="flex items-center justify-between mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors">&lt;</button><h3 id="calendar-title" class="text-xl font-bold text-white"></h3><button id="next-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors">&gt;</button></div><div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 mb-2"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div></div><div id="calendar-grid" class="calendar-grid-class"></div></div></section>`;
            mainEl.innerHTML = html;
        }

        // --- EVENT HANDLERS ---
        function setupEventListeners() {
            document.querySelectorAll('.tab-button').forEach(tab => tab.addEventListener('click', handleTabClick));
            mainEl.addEventListener('click', handleMainClick);
            document.body.addEventListener('click', handleModalAndDifficultyClicks);
        }

        function handleTabClick(e) {
            const tabEl = e.target.closest('.tab-button');
            if (!tabEl) return;
            const tabId = tabEl.getAttribute('data-tab');
            if (tabEl.classList.contains('locked')) {
                alert('Este treino ainda não está liberado! Foco na fase atual.');
                return;
            }
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            document.querySelectorAll('.content-section').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            if (tabId === 'historico') renderCalendar(currentCalendarDate);
            if (tabId === 'dashboard') renderDashboard();
        }
        
        function handleMainClick(e) {
            if (e.target.matches('.finish-workout-btn')) {
                finishWorkout(e.target.closest('.bg-gray-800[data-day-title]'));
            } else if (e.target.closest('.calendar-day.has-workout')) {
                editLogKey = e.target.closest('.calendar-day.has-workout').dataset.logKey;
                openModal('edit-modal');
                populateEditModal(editLogKey);
            } else if (e.target.closest('.difficulty-ratings')) {
                const btn = e.target.closest('.difficulty-btn');
                if (btn) handleDifficultySelection(btn);
            }
        }

        function handleModalAndDifficultyClicks(e) {
            if(e.target.matches('.close-modal-btn')) return closeAllModals();
            if(!activeModal) return;

            const difficultyBtn = e.target.closest('.difficulty-btn');
            if(difficultyBtn) {
                handleDifficultySelection(difficultyBtn);
                if (activeModal.id === 'completion-modal') {
                    const todayKey = getTodayKey();
                    const tempLog = { ...workoutLog[todayKey] };
                    tempLog.difficulty = parseInt(difficultyBtn.dataset.value);
                    const workoutCard = document.querySelector(`[data-day-title="${tempLog.dayTitle}"]`);
                    const score = calculateSmartScore(tempLog, workoutCard);
                    document.getElementById('modal-score').textContent = score.toFixed(1);
                    document.getElementById('modal-score-placeholder').style.display = 'none';
                    document.getElementById('modal-score').style.display = 'block';
                }
            }

            if (activeModal.id === 'completion-modal' && e.target.matches('#save-workout-btn')) {
                const selectedDiff = activeModal.querySelector('.difficulty-btn.selected');
                if (!selectedDiff) {
                    alert('Por favor, selecione um nível de dificuldade para o treino.');
                    return;
                }
                const todayKey = getTodayKey();
                const log = workoutLog[todayKey];
                log.difficulty = parseInt(selectedDiff.dataset.value);
                const workoutCard = document.querySelector(`[data-day-title="${log.dayTitle}"]`);
                log.smartScore = calculateSmartScore(log, workoutCard);
                saveState();
                alert(`Treino salvo! Sua nota final foi: ${log.smartScore.toFixed(1)}`);
                closeAllModals();
                renderDashboard();
            } else if (activeModal.id === 'edit-modal') {
                if(e.target.matches('#save-edit-btn')) saveEdits();
                if(e.target.matches('#delete-log-btn')) deleteLog();
            }
        }
        
        function handleDifficultySelection(button) {
             button.parentElement.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
             button.classList.add('selected');
        }

        // --- CORE LOGIC ---
        function calculateSmartScore(log, workoutCard) {
            if (!log || !workoutCard) return 0;
            const checkboxes = workoutCard.querySelectorAll('.exercise-list .exercise-checkbox');
            const completedCount = log.completedExercises?.length || 0;
            const baseScore = checkboxes.length > 0 ? (completedCount / checkboxes.length) * 10 : 0;
            
            let difficultyDelta = 0;
            const diff = log.difficulty;
            if (diff === 1) difficultyDelta = -1.0;
            if (diff === 2) difficultyDelta = -0.5;
            if (diff === 4) difficultyDelta = 0.75;
            if (diff === 5) difficultyDelta = 1.25;
            
            let cardioDelta = 0;
            const cardio = log.cardio;
            if (!cardio || cardio.minutes <= 0) {
                cardioDelta = -1.0;
            } else if (cardio.minutes < 20) {
                cardioDelta = 0.5;
            } else {
                cardioDelta = 1.5;
            }

            const finalScore = baseScore + difficultyDelta + cardioDelta;
            return Math.max(0, Math.min(10, finalScore));
        }

        function finishWorkout(workoutCard) {
            const todayKey = getTodayKey();
            if (!workoutLog[todayKey]) workoutLog[todayKey] = {};
            const log = workoutLog[todayKey];

            log.phase = workoutCard.closest('[data-phase]').dataset.phase;
            log.dayTitle = workoutCard.dataset.dayTitle;
            
            const exercisesInCard = workoutCard.querySelectorAll('.exercise-list .exercise-checkbox');
            const completedInCard = workoutCard.querySelectorAll('.exercise-list .exercise-checkbox:checked');

            const totalExercises = exercisesInCard.length;
            const completedCount = completedInCard.length;
            
            if (totalExercises > 0 && (completedCount / totalExercises) < 0.5) {
                const required = Math.ceil(totalExercises / 2);
                alert(`Você precisa completar pelo menos 50% dos exercícios (${required} de ${totalExercises}) para registrar o treino. Atualmente: ${completedCount}.`);
                return;
            }
            log.completedExercises = Array.from(completedInCard).map(cb => cb.id);

            const idPrefix = workoutCard.dataset.idPrefix;
            const cardioMinutes = parseInt(document.getElementById(`cardio-minutes-${idPrefix}`).value, 10);
            if(cardioMinutes > 0) {
                const cardioType = document.getElementById(`cardio-type-${idPrefix}`).value;
                const cardioDiffBtn = workoutCard.querySelector(`.cardio-section .difficulty-btn.selected`);
                log.cardio = { type: cardioType, minutes: cardioMinutes, difficulty: cardioDiffBtn ? parseInt(cardioDiffBtn.dataset.value) : null };
            } else {
                delete log.cardio;
            }
            saveState();
            
            const modal = document.getElementById('completion-modal');
            modal.querySelector('.difficulty-ratings').innerHTML = difficultyEmojis;
            const scorePlaceholder = modal.querySelector('#modal-score-placeholder');
            const scoreDisplay = modal.querySelector('#modal-score');
            scoreDisplay.textContent = '';
            scoreDisplay.style.display = 'none';
            scorePlaceholder.style.display = 'block';
            openModal('completion-modal');
        }

        // --- EDIT/DELETE LOGIC ---
        function populateEditModal(logKey) {
            const log = workoutLog[logKey];
            if (!log) return;
            
            document.getElementById('edit-modal-title').textContent = `Editando: ${new Date(logKey + 'T00:00:00').toLocaleDateString('pt-BR')}`;
            document.getElementById('edit-modal-score').textContent = log.smartScore?.toFixed(1) || "-";
            
            const exContainer = document.getElementById('edit-modal-exercises');
            exContainer.innerHTML = '';
            const phase = workoutDatabase[log.phase];
            const day = phase?.days.find(d => d.title === log.dayTitle);
            if(day) {
                const list = document.createElement('ul'); list.className = 'space-y-3';
                day.exercises.forEach(ex => {
                    const isChecked = log.completedExercises?.includes(ex.id);
                    list.innerHTML += `<li class="flex items-center"><input type="checkbox" id="edit-${ex.id}" data-original-id="${ex.id}" class="exercise-checkbox mr-4" ${isChecked ? 'checked' : ''}><label for="edit-${ex.id}" class="exercise-label">${ex.text}</label></li>`;
                });
                exContainer.appendChild(list);
            } else {
                 exContainer.innerHTML = '<p class="text-gray-500">Não foi possível carregar a lista de exercícios.</p>';
            }

            const diffContainer = document.getElementById('edit-modal-difficulty');
            diffContainer.innerHTML = difficultyEmojis;
            if(log.difficulty) diffContainer.querySelector(`.difficulty-btn[data-value='${log.difficulty}']`)?.classList.add('selected');

            const cardioContainer = document.getElementById('edit-modal-cardio');
            const cardio = log.cardio;
            cardioContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="edit-cardio-type" class="block text-gray-300 mb-1 text-sm">Tipo</label><select id="edit-cardio-type" class="w-full p-2 rounded bg-gray-700 text-white"><option>Esteira</option><option>Bicicleta</option><option>Elíptico</option><option>Outro</option></select></div><div><label for="edit-cardio-minutes" class="block text-gray-300 mb-1 text-sm">Minutos</label><input type="number" id="edit-cardio-minutes" class="w-full p-2 rounded bg-gray-700 text-white" value="${cardio?.minutes || 0}"></div></div><div><p class="text-sm text-gray-400 mb-2">Dificuldade do Cardio</p><div class="difficulty-ratings flex justify-start space-x-4">${difficultyEmojis}</div></div>`;
            if(cardio) {
                document.getElementById('edit-cardio-type').value = cardio.type || 'Esteira';
                cardioContainer.querySelector(`.difficulty-ratings .difficulty-btn[data-value='${cardio.difficulty}']`)?.classList.add('selected');
            }
        }
        
        function saveEdits() {
            if(!editLogKey || !workoutLog[editLogKey]) return;
            const log = workoutLog[editLogKey];

            const workoutDiffBtn = document.querySelector('#edit-modal-difficulty .difficulty-btn.selected');
            if(!workoutDiffBtn) {
                alert('Por favor, selecione uma dificuldade para o treino.');
                return;
            }
            log.difficulty = parseInt(workoutDiffBtn.dataset.value);

            log.completedExercises = Array.from(document.querySelectorAll('#edit-modal-exercises .exercise-checkbox:checked')).map(cb => cb.dataset.originalId);
            
            const cardioMins = parseInt(document.getElementById('edit-cardio-minutes')?.value || 0);
            if (cardioMins > 0) {
                const cardioDiffBtn = document.querySelector('#edit-modal-cardio .difficulty-ratings .difficulty-btn.selected');
                log.cardio = { type: document.getElementById('edit-cardio-type')?.value, minutes: cardioMins, difficulty: cardioDiffBtn ? parseInt(cardioDiffBtn.dataset.value) : null };
            } else {
                delete log.cardio;
            }
            
            const phase = workoutDatabase[log.phase];
            const day = phase?.days.find(d => d.title === log.dayTitle);
            const workoutCardMock = document.createElement('div');
            if (day) {
                const list = document.createElement('ul');
                day.exercises.forEach(ex => list.innerHTML += `<li><input class="exercise-checkbox"></li>`);
                workoutCardMock.appendChild(list);
            }
            log.smartScore = calculateSmartScore(log, workoutCardMock);

            saveState();
            closeAllModals();
            renderCalendar(currentCalendarDate);
            renderDashboard();
        }

        function deleteLog() {
            if(editLogKey && confirm(`Tem certeza que deseja excluir o registro do dia ${new Date(editLogKey + 'T00:00:00').toLocaleDateString('pt-BR')}?`)) {
                delete workoutLog[editLogKey];
                saveState();
                closeAllModals();
                renderCalendar(currentCalendarDate);
                renderDashboard();
            }
        }

        function renderDashboard() {
            const today = new Date();
            const currentMonthStr = today.toISOString().slice(0, 7);
            const weekRange = getWeekRange(today);
            const logs = Object.entries(workoutLog);

            const thisMonthLogs = logs.filter(([key]) => key.startsWith(currentMonthStr));
            const thisWeekLogs = logs.filter(([key]) => {
                const logDate = new Date(key + 'T00:00:00');
                return logDate >= weekRange.start && logDate <= weekRange.end;
            });
            
            document.getElementById('stat-days-trained').textContent = thisMonthLogs.length;

            const calcAvgScore = (arr) => arr.length > 0 ? (arr.reduce((sum, [, log]) => sum + (log.smartScore || 0), 0) / arr.length).toFixed(1) : "-";
            document.getElementById('stat-avg-score-month').textContent = calcAvgScore(thisMonthLogs);
            document.getElementById('stat-avg-score-week').textContent = calcAvgScore(thisWeekLogs);
            
            const cardioMinutes = thisMonthLogs.reduce((sum, [, log]) => sum + (log.cardio?.minutes || 0), 0);
            document.getElementById('stat-cardio-minutes').textContent = cardioMinutes;

            const getMostFrequent = (arr) => {
                if (arr.length === 0) return "-";
                const counts = arr.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            };
            document.getElementById('stat-fav-cardio').textContent = getMostFrequent(logs.map(([, log]) => log.cardio?.type).filter(Boolean));
            document.getElementById('stat-fav-workout').textContent = getMostFrequent(logs.map(([, log]) => log.dayTitle).filter(Boolean));
        }

        function renderCalendar(date) {
            const calendarGrid = document.getElementById('calendar-grid');
            if(!calendarGrid) return;
            calendarGrid.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            document.getElementById('calendar-title').textContent = `${date.toLocaleString('pt-BR', { month: 'long' }).replace(/^\w/, c => c.toUpperCase())} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.innerHTML += `<div class="calendar-day other-month"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                if (workoutLog[dayKey]) {
                    dayDiv.classList.add('has-workout');
                    dayDiv.dataset.logKey = dayKey;
                }
                calendarGrid.appendChild(dayDiv);
            }
        }
        
        function lockWorkoutPhases() {
            const currentMonth = new Date().getMonth() + 1;
            document.querySelectorAll('.tab-button[data-tab^="fase-"]').forEach(tab => {
                const tabId = tab.dataset.tab;
                if (phaseAccessRules[tabId] && !phaseAccessRules[tabId].includes(currentMonth)) {
                    tab.classList.add('locked');
                }
            });
        }
        
        function init() {
            buildLayout();
            setupEventListeners();
            lockWorkoutPhases();
            loadInitialState();
            renderDashboard();
            
            document.querySelector('body').addEventListener('click', e => {
                const calendarGrid = document.getElementById('calendar-grid');
                if (calendarGrid?.contains(e.target)) return;
                if(e.target.id === 'prev-month') { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate); }
                if(e.target.id === 'next-month') { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate); }
            });
        }

        function loadInitialState() {
            const todayKey = getTodayKey();
            if (!workoutLog[todayKey]) return;
            const log = workoutLog[todayKey];

            const workoutCard = document.querySelector(`[data-day-title="${log.dayTitle}"]`);
            if (!workoutCard) return;

            if (log.completedExercises) {
                workoutCard.querySelectorAll('.exercise-list .exercise-checkbox').forEach(cb => {
                    if (log.completedExercises.includes(cb.id)) {
                        cb.checked = true;
                    }
                });
            }
            if(log.cardio) {
                const idPrefix = workoutCard.dataset.idPrefix;
                document.getElementById(`cardio-type-${idPrefix}`).value = log.cardio.type || 'Esteira';
                document.getElementById(`cardio-minutes-${idPrefix}`).value = log.cardio.minutes || 0;
                const diffBtn = workoutCard.querySelector(`.cardio-section .difficulty-btn[data-value='${log.cardio.difficulty}']`);
                if(diffBtn) diffBtn.classList.add('selected');
            }
        }

        init();
    });
    </script>
</body>
</html>